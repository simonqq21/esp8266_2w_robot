<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width initial-scale=1.0">
    <title></title>
    <style>
        * {
            font-family: Arial, serif;
        }

        header {
            padding: 0.1em 1.5em;
            background: #abcdef;
        }

        #instructions {
        
        }

        #toggleControls { 
            display: flex;
            justify-content: center;
            
        }

        #joystickContainer {
            margin: 20px;
            display: flex;
            justify-content: center;
        }
        
        input[type="button"] {
            height: 40px;
            min-width: 50px;
            border-radius: 20px;
            margin: 10px 2px 0;
            font-size: 15px;
            color: black;
        }

        #honk {
            background-color: orange;
        }

        #joystick_svg {
            width: 220px;
            height: 220px;
            border: none;
        }

    </style>
    <script src="jquery_min.js"></script>
</head>  
<body>
    <header>
        <h1>ESP8266 WiFi robot</h1>
    </header>
    <div id="controls">
        <div id="joystickContainer">
            <iframe src="joystick.html" id="joystick_svg" content="text/html" charset="UTF-8">
            </iframe>
        </div> 
        <div id="toggleControls">
            <div>
                <input type="checkbox" id="lights" name="lights" value="lights">
                <label for="lights">Lights</label>
                <input type="button" id="honk" name="honk" value="honk">
                <label for="honk">Honk</label>
            </div>
        </div> 
        <div id="instructions">
            <h2>Instructions</h2>
            <p>Move the joystick with your mouse or finger to move the robot.</p>
            <p>On a desktop browser, the WASD keys can be used to move the robot 
                and the - and + keys can be used to adjust the speed.</p>
            <p>The readout below the joystick displays the distance measured by the ultrasonic sensor.</p>
            <p>The toggle controls below control the lights and the buzzer horn.</p>    
        </div>
    </div>
           
</body>
<script type="text/javascript">
    let i=0;
     

    $(document).ready(function() {
        // alert(isTouchEnabled());
        // if (isTouchEnabled()) {
        //     $("*").onmousedown = ""; 
        //     $("*").onmouseup = "";
        // }
        // else {
        //     $("*").ontouchstart = ""; 
        //     $("*").ontouchend = "";
        // } 

        const joystick = $("#joystick_svg");
        joystick.on("load", function() {
            
            const joystickObj = $("#joystick_svg");
            const joystickDoc = joystickObj.contents();
            const stickGroup = joystickDoc.find("#stick_group");
            
            let isDragging = false; 
            let offsetX, offsetY; 
            let newX, newY;
            let stickCenterX, stickCenterY;
            let translateX, translateY;

            let stickRect = stickGroup.get(0).getBoundingClientRect();
            const origX = (stickRect.left + stickRect.right) / 2;
            const origY = (stickRect.top + stickRect.bottom) / 2;
            console.log(origX, ", ", origY);

            stickGroup.bind("mousedown touchstart", function (event) {
                if (isTouchEnabled()) {
                    event.preventDefault();
                }
                isDragging = true;
                // offsetX = event.offsetX;
                // offsetY = event.offsetY;
                // console.log(offsetX, ", ", offsetY);
            });
            
            const joystickObj2 = document.getElementById("joystick_svg");
            const joystickDoc2 = joystickObj2.contentDocument;
            const stickGroup2 = joystickDoc2.querySelector("#stick_group");
            console.log(stickGroup2 instanceof SVGGraphicsElement);
            const SVGStickMatrix = stickGroup2.getScreenCTM().inverse();

            let p;

            joystickDoc.bind("mousemove touchmove", function(event) {
                if (isTouchEnabled()) {
                    event.preventDefault();
                }

                if (isDragging) {
                    stickCenterX = stickGroup.offset().left + stickGroup.width() / 2;
                    stickCenterY = stickGroup.offset().top + stickGroup.height() / 2; 

                    let inputX, inputY;
                    if (isTouchEnabled()) {
                        inputX = event.touches[0].clientX;
                        inputY = event.touches[0].clientY;
                    }
                    else {
                        inputX = event.clientX;
                        inputY = event.clientY;
                    }

                    translateX = inputX - origX;
                    translateY = inputY - origY;
                    
                    translateX = translateX * 2.14;
                    translateY = translateY * 2.14; 

                    p = new DOMPoint(translateX, translateY);
                    let points = p.matrixTransform(SVGStickMatrix);
                    console.log(translateX, translateY, points); 

                    // console.log(event.clientX, ", ", origX+translateX, ", ", stickCenterX);
                    // stickGroup.attr("transform", `translate(${translateX},${translateY})`);
                    stickGroup.attr("transform", `translate(${points.x},${points.y})`);
                }
            });

            joystickDoc.bind("mouseup touchend", function () {
                if (isTouchEnabled()) {
                    event.preventDefault();
                }
                isDragging = false;
                stickGroup.attr("transform", "translate(0,0)");
            });
            
            // stickGroup.ontouchstart(function (event) {
            //     isDragging = true;
            //     // offsetX = event.offsetX;
            //     // offsetY = event.offsetY;
            //     // console.log(offsetX, ", ", offsetY);
            // });

            // joystickDoc.ontouchmove(function(event) {
            //     if (isDragging) {
            //         stickCenterX = stickGroup.offset().left + stickGroup.width() / 2;
            //         stickCenterY = stickGroup.offset().top + stickGroup.height() / 2; 

            //         translateX = event.clientX - origX;
            //         translateY = event.clientY - origY;
                    
            //         translateX = translateX * 2.14;
            //         translateY = translateY * 2.14; 

            //         // console.log(event.clientX, ", ", origX+translateX, ", ", stickCenterX);
            //         // stickGroup.attr("transform", `translate(${translateX},${translateY})`);
            //         stickGroup.attr("transform", `translate(${translateX},${translateY})`);
            //     }
            // });
            
            // joystickDoc.ontouchend(function () {
            //     isDragging = false;
            //     stickGroup.attr("transform", "translate(0,0)");
            // });
            // .mousemove(function(event) {
            //     const mouseX = event.pageX;
            //     const mouseY = event.pageY;
            //     
            // });
        });

        
    });
    
    

    function isTouchEnabled() {
        return ('ontouchstart' in window) || 
            (navigator.maxTouchPoints > 0) || 
            (navigator.msMaxTouchPoints > 0);
    }
</script>
</html>