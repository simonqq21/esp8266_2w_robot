<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width initial-scale=1.0">
    <title></title>
    <style>
        * {
            font-family: Arial, serif;
        }

        header {
            padding: 0.1em 1.5em;
            background: #abcdef;
        }

        #instructions {
        
        }

        #toggleControls { 
            display: flex;
            justify-content: center;
            
        }

        #joystickContainer {
            margin: 20px;
            display: flex;
            justify-content: center;
        }
        
        input[type="button"] {
            height: 40px;
            min-width: 50px;
            border-radius: 20px;
            margin: 10px 2px 0;
            font-size: 15px;
            color: black;
        }

        #honk {
            background-color: orange;
        }

        #joystick_svg {
            width: 220px;
            height: 220px;
            border: none;
            transform: scale(0.5);
            transform-origin: top left;
        }

    </style>
    <script src="jquery_min.js"></script>
</head>  
<body>
    <header>
        <h1>ESP8266 WiFi robot</h1>
    </header>
    <div id="controls">
        <div id="joystickContainer">
            <div id="joystick_svg">
                <svg width="400" height="400" viewBox="0 0 400 400" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect width="400" height="400" fill="#1E1E1E"/>
                <g id="joystick">
                <g clip-path="url(#clip0_0_1)">
                <rect width="400" height="400" fill="#D9D9D9"/>
                
                <g id="actuation_area_group">
                <circle id="actuation_area" cx="200" cy="200" r="200" fill="#666666"/>
                </g>
                
                <g id="stick_group">
                <circle id="stick" cx="200" cy="200" r="75" fill="#00FFC2"/>
                </g>
                
                <g id="directional_markers">
                <path id="left_marker" d="M38 200L75.5 148.038V251.962L38 200Z" fill="#D9D9D9"/>
                <path id="right_marker" d="M362 200L324.5 251.962V148.038L362 200Z" fill="#D9D9D9"/>
                <path id="up_marker" d="M200 38L251.962 75.5H148.038L200 38Z" fill="#D9D9D9"/>
                <path id="down_marker" d="M200 362L148.038 324.5H251.962L200 362Z" fill="#D9D9D9"/>
                </g>
                
                </g>
                <rect x="0.5" y="0.5" width="399" height="399" stroke="black"/>
                </g>
                <defs>
                <clipPath id="clip0_0_1">
                <rect width="400" height="400" fill="white"/>
                </clipPath>
                </defs>
                </svg>
            </div>
        </div> 
        <div id="toggleControls">
            <div>
                <input type="checkbox" id="lights" name="lights" value="lights">
                <label for="lights">Lights</label>
                <input type="button" id="honk" name="honk" value="honk">
                <label for="honk">Honk</label>
            </div>
        </div> 
        <div id="instructions">
            <h2>Instructions</h2>
            <p>Move the joystick with your mouse or finger to move the robot.</p>
            <p>On a desktop browser, the WASD keys can be used to move the robot 
                and the - and + keys can be used to adjust the speed.</p>
            <p>The readout below the joystick displays the distance measured by the ultrasonic sensor.</p>
            <p>The toggle controls below control the lights and the buzzer horn.</p>    
        </div>
    </div>
           
</body>
<script type="text/javascript">
    let i=0;
     

    $(document).ready(function() {
        const joystick = $("#joystickContainer");
        const stickGroup = $("#stick_group");
        const actuationArea = $("#actuation_area_group");
        
        let isDragging = false; 
        let offsetX, offsetY; 
        let newX, newY;
        let stickCenterX, stickCenterY;
        let translateX, translateY;

        let stickRect = stickGroup.get(0).getBoundingClientRect();
        const origX = (stickRect.left + stickRect.right) / 2;
        const origY = (stickRect.top + stickRect.bottom) / 2;
        console.log(origX, ", ", origY);

        stickGroup.on("mousedown touchstart", function (event) {
            // if (isTouchEnabled()) {
            //     event.preventDefault();
            // }
            // alert("X");
            isDragging = true;
            // offsetX = event.offsetX;
            // offsetY = event.offsetY;
            // console.log(offsetX, ", ", offsetY);
        });

        function throttle(callback, delay) {
            let lastCall = 0; 
            return function(...args) {
                const now = new Date().getTime(); 
                if (now - lastCall < delay) return;
                lastCall = now;
                callback.apply(this, args);
            };
        }

        const throttledHandler = throttle(function(event) {
            if (isTouchEnabled()) {
                event.preventDefault();
            }

            if (isDragging) {
                stickCenterX = stickGroup.offset().left + stickGroup.width() / 2;
                stickCenterY = stickGroup.offset().top + stickGroup.height() / 2; 

                let inputX, inputY;
                if (isTouchEnabled()) {
                    inputX = event.touches[0].clientX;
                    inputY = event.touches[0].clientY;
                }
                else {
                    inputX = event.clientX;
                    inputY = event.clientY;
                }

                translateX = inputX - origX;
                translateY = inputY - origY;
                
                translateX = translateX * 2.14;
                translateY = translateY * 2.14; 

                // p = new DOMPoint(translateX, translateY);
                // let points = p.matrixTransform(SVGStickMatrix);
                // console.log(translateX, translateY, points); 

                // console.log(event.clientX, ", ", origX+translateX, ", ", stickCenterX);
                // stickGroup.attr("transform", `translate(${translateX},${translateY})`);
                stickGroup.attr("transform", `translate(${translateX},${translateY})`);
            }
        }, 10);
        
        $("#joystick_svg").on("mousemove touchmove", throttledHandler);

        $(document).on("mouseup touchend", function () {
            // if (isTouchEnabled()) {
            //     event.preventDefault();
            // }
            isDragging = false;
            stickGroup.attr("transform", "translate(0,0)");
        });
    });

    
    

    function isTouchEnabled() {
        return ('ontouchstart' in window) || 
            (navigator.maxTouchPoints > 0) || 
            (navigator.msMaxTouchPoints > 0);
    }
</script>
</html>